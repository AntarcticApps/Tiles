var Describe=function(a,b,c,e,d){this.parent=a;this.name=b;this.op=c;this.children=[];this.id=describeCount++;this.befores=e?e:[];this.afters=d?d:[]};Describe.prototype.toString=function(){return this.name};Describe.prototype.perform=function(a){var b=this;this.op();loop(0,this.children.length,function(a,e){enter(b.children[a],e)},a)};var Expect=function(a,b,c){this.parent=a;this.success=!1;this.value=b;this.other=null;this.type="";this.callStack=c;b&&(this.success=!0)};Expect.prototype.perform=function(a){a()};Expect.prototype.toMatch=function(a){this.other=a;this.success=(a=this.value.match(RegExp(a)))&&0<a.length;this.type="match"};Expect.prototype.toBe=function(a){this.other=a;this.success=this.value===a;this.type="be"};function isArray(a){return"[object Array]"===Object.prototype.toString.apply(a)}
function isObject(a){return"object"==typeof a}function isEqual(a,b){if(!a&&b||a&&!b)return!1;if(a==b)return!0;if(isArray(a)){if(isArray(b)){if(a.length!=b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]!=b[c])return!1;return!0}return!1}if(isObject(a)){if(!isObject(b))return!1;var c=0,e;for(e in b)c++;var d=0;for(e in a)if(d++,void 0==b[e]||!isEqual(a[e],b[e]))return!1;return c!=d?!1:!0}return a==b}Expect.prototype.toEqual=function(a){this.other=a;this.success=isEqual(this.value,a);this.type="equal"};
Expect.prototype.toNotEqual=function(a){this.other=a;this.success=!isEqual(this.value,a);this.type="not equal"};Expect.prototype.toBeUndefined=function(){this.success=void 0==this.val;this.type="undefined"};Expect.prototype.toBeNull=function(){this.success=null==this.val;this.type="null"};
Expect.prototype.toString=function(){var a="expected "+this.value;"match"==this.type?a+=" to match "+this.other:"be"==this.type?a+=" to be "+this.other:"equal"==this.type?a+=" to equal "+this.other:"undefined"==this.type?a+=" to be undefined":"null"==this.type&&(a+=" to be null");a+=": ";return a=this.success?a+"success":a+"failure"};var It=function(a,b,c,e,d){this.parent=a;this.name=b;this.op=c;this.children=[];this.expects=[];this.id=itCount++;this.befores=e?e:[];this.afters=d?d:[]};It.prototype.toString=function(){return this.name};
It.prototype.perform=function(a){function b(){d.op();loop(0,d.children.length,function(a,b){enter(d.children[a],b)},c)}function c(){loop(0,d.expects.length,function(a,b){enter(d.expects[a],b)},e)}function e(){d.afters?loop(0,d.afters.length,function(a,b){enter(d.afters[a],b)},a):a()}var d=this;d.befores?loop(0,d.befores.length,function(a,b){enter(d.befores[a],b)},b):b()};var Listener=function(){};Listener.prototype={onEnter:function(){},onExit:function(){}};function relayPeek(){return relayStack[relayStack.length-1]}function describe(a,b){relayPeek().children.push(new Describe(relayPeek(),a,b,relayPeek().befores.slice(0),relayPeek().afters.slice(0)))}function beforeEach(a){relayPeek().befores.push(new Run(relayPeek(),a))}function afterEach(a){relayPeek().afters.push(new Run(relayPeek(),a))}function it(a,b){relayPeek().children.push(new It(relayPeek(),a,b,relayPeek().befores.slice(0),relayPeek().afters.slice(0)))}
function runs(a,b){relayPeek().children.push(new Run(relayPeek(),a,relayPeek().befores.slice(0),relayPeek().afters.slice(0),b))}function expect(a){a=new Expect(relayPeek(),a,getCallStack(10));relayPeek().expects.push(a);return a}function enter(a,b){broadcast("onEnter",a);relayStack.push(a);a.perform(function(){exit(b)})}function exit(a){var b=relayStack.pop();broadcast("onExit",b);a()}
function relay(a){a&&(defaultTimeout=a);loop(0,root.children.length,function(a,c){enter(root.children[a],c)},function(){console.log("Relay done.")})}function loop(a,b,c,e){if(a<b)c(a,function(){loop(a+1,b,c,e)});else return e()}function closestAncestor(a,b){if(!b)return a.parent;for(var c=a.parent;!b(c);)c=c.parent;return c}
function getCallStack(a){try{throw Error("");}catch(b){for(var c=[],e=b.stack.split("\n"),d=0;d<a&&d<e.length;d++){var f=/[^\(]*\(([^\)]*)\)/ig.exec(e[d]);f&&2<=f.length&&c.push(safeTagsReplace(f[1]))}return c}}var tagsToReplace={"&":"&amp;","<":"&lt;",">":"&gt;"};function replaceTag(a){return tagsToReplace[a]||a}function safeTagsReplace(a){return a.replace(/[&<>]/g,replaceTag)}function addListener(a){listeners.push(a)}
function broadcast(a,b){for(var c=0;c<listeners.length;c++)listeners[c][a](b)}var listeners=[],relayStack=[],root=new Describe;relayStack.push(root);var describeCount=0,itCount=0,defaultTimeout=null;var Run=function(a,b,c,e,d){this.parent=a;this.op=b;this.expects=[];this.ran=!1;d?this.timeout=d:defaultTimeout&&(this.timeout=defaultTimeout);c&&(this.befores=c);e&&(this.afters=e)};
Run.prototype.perform=function(a){var b=this,c;b.timeout&&(c=setTimeout(function(){b.ran=!0;loop(0,b.expects.length,function(a,c){enter(b.expects[a],c)},function(){b.reset();a()})},b.timeout));b.op(function(){b.ran?console.error("Warning: run block completed after timed out."):(c&&clearTimeout(c),loop(0,b.expects.length,function(a,c){enter(b.expects[a],c)},function(){b.reset();a()}))})};Run.prototype.reset=function(){this.ran=!1};
