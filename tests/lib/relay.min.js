var Describe=function(a,b,c,d,e){this.parent=a;this.name=b;this.op=c;this.children=[];this.id=describeCount++;this.befores=d?d:[];this.afters=e?e:[]};Describe.prototype.toString=function(){return this.name};Describe.prototype.perform=function(a){var b=this;this.op();loop(0,this.children.length,function(a,d){enter(b.children[a],d)},a)};var Expect=function(a,b,c){this.parent=a;this.success=!1;this.value=b;this.other=null;this.type="";this.callStack=c;b&&(this.success=!0)};Expect.prototype.perform=function(a){a()};Expect.prototype.toMatch=function(a){this.other=a;this.success=(a=this.value.match(RegExp(a)))&&0<a.length;this.type="match"};Expect.prototype.toBe=function(a){this.other=a;this.success=this.value===a;this.type="be"};function isArray(a){return"[object Array]"===Object.prototype.toString.apply(a)}
function isObject(a){return"object"==typeof a}function isEqual(a,b){if(!a&&b||a&&!b)return!1;if(a==b)return!0;if(isArray(a)){if(isArray(b)){if(a.length!=b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]!=b[c])return!1;return!0}return!1}if(isObject(a)){if(!isObject(b))return!1;var c=0,d;for(d in b)c++;var e=0;for(d in a)if(e++,void 0==b[d]||!isEqual(a[d],b[d]))return!1;return c!=e?!1:!0}return a==b}Expect.prototype.toEqual=function(a){this.other=a;this.success=isEqual(this.value,a);this.type="equal"};
Expect.prototype.toNotEqual=function(a){this.other=a;this.success=!isEqual(this.value,a);this.type="not equal"};Expect.prototype.toBeUndefined=function(){this.success=void 0==this.val;this.type="undefined"};Expect.prototype.toBeNull=function(){this.success=null==this.val;this.type="null"};
Expect.prototype.toString=function(){var a="expected "+this.value;"match"==this.type?a+=" to match "+this.other:"be"==this.type?a+=" to be "+this.other:"equal"==this.type?a+=" to equal "+this.other:"undefined"==this.type?a+=" to be undefined":"null"==this.type&&(a+=" to be null");a+=": ";return a=this.success?a+"success":a+"failure"};var It=function(a,b,c,d,e){this.parent=a;this.name=b;this.op=c;this.children=[];this.expects=[];this.id=itCount++;this.befores=d?d:[];this.afters=e?e:[]};It.prototype.toString=function(){return this.name};
It.prototype.perform=function(a){function b(){e.op();loop(0,e.children.length,function(a,b){enter(e.children[a],b)},c)}function c(){loop(0,e.expects.length,function(a,b){enter(e.expects[a],b)},d)}function d(){e.afters?loop(0,e.afters.length,function(a,b){enter(e.afters[a],b)},a):a()}var e=this;e.befores?loop(0,e.befores.length,function(a,b){enter(e.befores[a],b)},b):b()};var Listener=function(){};Listener.prototype={onEnter:function(){},onExit:function(){}};function relayPeek(){return relayStack[relayStack.length-1]}function describe(a,b){relayPeek().children.push(new Describe(relayPeek(),a,b,relayPeek().befores.slice(0),relayPeek().afters.slice(0)))}function beforeEach(a){relayPeek().befores.push(new Run(relayPeek(),a))}function afterEach(a){relayPeek().afters.push(new Run(relayPeek(),a))}function it(a,b){relayPeek().children.push(new It(relayPeek(),a,b,relayPeek().befores.slice(0),relayPeek().afters.slice(0)))}
function runs(a){relayPeek().children.push(new Run(relayPeek(),a,relayPeek().befores.slice(0),relayPeek().afters.slice(0)))}function expect(a){a=new Expect(relayPeek(),a,getCallStack(10));relayPeek().expects.push(a);return a}function enter(a,b){broadcast("onEnter",a);relayStack.push(a);a.perform(function(){exit(b)})}function exit(a){var b=relayStack.pop();broadcast("onExit",b);a()}
function relay(){loop(0,root.children.length,function(a,b){enter(root.children[a],b)},function(){console.log("Relay done.")})}function loop(a,b,c,d){if(a<b)c(a,function(){loop(a+1,b,c,d)});else return d()}function closestAncestor(a,b){if(!b)return a.parent;for(var c=a.parent;!b(c);)c=c.parent;return c}
function getCallStack(a){try{throw Error("");}catch(b){for(var c=[],d=b.stack.split("\n"),e=0;e<a&&e<d.length;e++){var f=/[^\(]*\(([^\)]*)\)/ig.exec(d[e]);f&&2<=f.length&&c.push(safeTagsReplace(f[1]))}return c}}var tagsToReplace={"&":"&amp;","<":"&lt;",">":"&gt;"};function replaceTag(a){return tagsToReplace[a]||a}function safeTagsReplace(a){return a.replace(/[&<>]/g,replaceTag)}function addListener(a){listeners.push(a)}
function broadcast(a,b){for(var c=0;c<listeners.length;c++)listeners[c][a](b)}var listeners=[],relayStack=[],root=new Describe;relayStack.push(root);var describeCount=0,itCount=0;var Run=function(a,b,c,d){this.parent=a;this.op=b;this.expects=[];c&&(this.befores=c);d&&(this.afters=d)};Run.prototype.perform=function(a){var b=this;b.op(function(){loop(0,b.expects.length,function(a,d){enter(b.expects[a],d)},function(){a()})})};
