var Describe=function(a,b,d,e,c){this.parent=a;this.name=b;this.op=d;this.children=[];this.id=describeCount++;this.befores=e?e:[];this.afters=c?c:[]};Describe.prototype.toString=function(){return this.name};Describe.prototype.perform=function(a){var b=this;this.op();loop(0,this.children.length,function(a,e){enter(b.children[a],e)},a)};var Expect=function(a,b,d){this.parent=a;this.success=!1;this.value=b;this.other=null;this.type="";this.callerLine=d;b&&(this.success=!0)};Expect.prototype.perform=function(a){a()};Expect.prototype.toMatch=function(a){this.other=a;this.success=(a=this.value.match(RegExp(a)))&&0<a.length;this.type="match"};Expect.prototype.toBe=function(a){this.other=a;this.success=this.value===a;this.type="be"};
Expect.prototype.toEqual=function(a){this.other=a;if(!this.value&&a||this.value&&!a)this.success=!1;else if(this.value==a)this.success=!0;else if(this.value.length!=a.length)this.success=!1;else{this.success=!0;for(var b=0;b<this.value.length;b++)if(this.value[b]!=a[b]){this.success=!1;break}}this.type="equal"};Expect.prototype.toBeUndefined=function(){this.success=void 0==this.val;this.type="undefined"};Expect.prototype.toBeNull=function(){this.success=null==this.val;this.type="null"};
Expect.prototype.toString=function(){var a="expected "+this.value;"match"==this.type?a+=" to match "+this.other:"be"==this.type?a+=" to be "+this.other:"equal"==this.type?a+=" to equal "+this.other:"undefined"==this.type?a+=" to be undefined":"null"==this.type&&(a+=" to be null");a+=": ";return a=this.success?a+"success":a+"failure"};var It=function(a,b,d,e,c){this.parent=a;this.name=b;this.op=d;this.children=[];this.expects=[];this.id=itCount++;this.befores=e?e:[];this.afters=c?c:[]};It.prototype.toString=function(){return this.name};
It.prototype.perform=function(a){function b(){c.op();loop(0,c.children.length,function(a,b){enter(c.children[a],b)},d)}function d(){loop(0,c.expects.length,function(a,b){enter(c.expects[a],b)},e)}function e(){c.afters?loop(0,c.afters.length,function(a,b){enter(c.afters[a],b)},a):a()}var c=this;c.befores?loop(0,c.befores.length,function(a,b){enter(c.befores[a],b)},b):b()};var Listener=function(){};Listener.prototype={onEnter:function(){},onExit:function(){}};function relayPeek(){return relayStack[relayStack.length-1]}function describe(a,b){relayPeek().children.push(new Describe(relayPeek(),a,b,relayPeek().befores,relayPeek().afters))}function beforeEach(a){relayPeek().befores.push(new Run(relayPeek(),a))}function afterEach(a){relayPeek().afters.push(new Run(relayPeek(),a))}function it(a,b){relayPeek().children.push(new It(relayPeek(),a,b,relayPeek().befores,relayPeek().afters))}
function runs(a,b){relayPeek().children.push(new Run(relayPeek(),a,relayPeek().befores,relayPeek().afters,b))}function expect(a){a=new Expect(relayPeek(),a,getCallerLineNumber());relayPeek().expects.push(a);return a}function enter(a,b){broadcast("onEnter",a);relayStack.push(a);a.perform(function(){exit(b)})}function exit(a){var b=relayStack.pop();broadcast("onExit",b);a()}
function relay(a){a&&(defaultTimeout=a);loop(0,root.children.length,function(a,d){enter(root.children[a],d)},function(){console.log("Relay done.")})}function loop(a,b,d,e){if(a<b)d(a,function(){loop(a+1,b,d,e)});else return e()}function getCallerLineNumber(){try{throw Error("");}catch(a){var b=a.stack.split("\n")[5];return/[^\(]*\(([^\)]*)\)/ig.exec(b)[1]}}function addListener(a){listeners.push(a)}function broadcast(a,b){for(var d=0;d<listeners.length;d++)listeners[d][a](b)}
var listeners=[],relayStack=[],root=new Describe;relayStack.push(root);var describeCount=0,itCount=0,defaultTimeout=null;var Run=function(a,b,d,e,c){this.parent=a;this.op=b;this.expects=[];this.ran=!1;c?this.timeout=c:defaultTimeout&&(this.timeout=defaultTimeout);d&&(this.befores=d);e&&(this.afters=e)};
Run.prototype.perform=function(a){var b=this,d;b.timeout&&(d=setTimeout(function(){b.ran=!0;loop(0,b.expects.length,function(a,c){enter(b.expects[a],c)},a)},b.timeout));b.op(function(){b.ran?console.error("Warning: run block completed after timed out."):(d&&clearTimeout(d),loop(0,b.expects.length,function(a,c){enter(b.expects[a],c)},a))})};
